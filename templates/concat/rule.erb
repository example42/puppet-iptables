<% if scope.lookupvar('rule') != '' -%>
<%= @command %> <%= @chain %> <%= scope.lookupvar('rule') %> -j <%= scope.lookupvar('target') %> 
<% else -%>
<% if scope.lookupvar('array_source').length > 0 -%>
<% scope.lookupvar('array_source').each do |s| -%>
<% if scope.lookupvar('array_destination').length > 0 -%>
<% scope.lookupvar('array_destination').each do |d| -%>
<%= @command %> <%= @chain %> <%= @true_in_interface %> <%= @true_out_interface %> <%= scope.lookupvar('true_protocol') %> <%= scope.lookupvar('true_port') %> -s <%= s %> -d <%= d %> -j <%= scope.lookupvar('target') %>
<% end -%>
<% else -%>
<%= @command %> <%= @chain %> <%= @true_in_interface %> <%= @true_out_interface %> <%= scope.lookupvar('true_protocol') %> <%= scope.lookupvar('true_port') %> -s <%= s %> -j <%= scope.lookupvar('target') %>
<% end -%>
<% end -%>
<% else -%>
<%= @command %> <%= @chain %> <%= @true_in_interface %> <%= @true_out_interface %> <%= scope.lookupvar('true_protocol') %> <%= scope.lookupvar('true_port') %> -j <%= scope.lookupvar('target') %>
<% end -%>
<% end -%>
